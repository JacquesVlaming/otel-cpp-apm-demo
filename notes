gcloud compute ssh redhat9 --zone us-central1-b

sudo dnf update

sudo dnf install git -y

sudo dnf install cmake -y

sudo dnf groupinstall "Development Tools" -y

sudo dnf install nano -y

sudo dnf install protobuf-devel grpc-devel abseil-cpp-devel -y

git clone https://github.com/JacquesVlaming/otel-cpp-apm-demo.git

git clone https://github.com/open-telemetry/opentelemetry-cpp.git

cd opentelemetry-cpp

mkdir build && cd build

cmake .. \
-DBUILD_SHARED_LIBS=ON \
-DWITH_OTLP_GRPC=ON \
-DCMAKE_INSTALL_PREFIX=$HOME/otel-cpp/install \
-DWITH_EXAMPLES=OFF \
-DBUILD_TESTING=OFF

make -j$(nproc)
sudo make install
sudo ldconfig

cd /otel-cpp-apm-demo
g++ -std=c++17 -shared -fPIC libotel_preload.cpp -o libotel_preload.so \
-I$HOME/otel-cpp/install/include \
-L$HOME/otel-cpp/install/lib64 \
-lopentelemetry_exporter_otlp_grpc \
-lopentelemetry_trace \
-ldl -lpthread

sudo dnf -y install dnf-plugins-core
sudo dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo
sudo dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl enable --now docker

sudo docker run --rm -it \
  -v "$(pwd)/otel-collector-config.yaml:/etc/otelcol/config.yaml" \
  -p 4317:4317 -p 4318:4318 \
  otel/opentelemetry-collector:latest \
  --config /etc/otelcol/config.yaml


export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
export OTEL_EXPORTER_OTLP_INSECURE=true
export OTEL_RESOURCE_ATTRIBUTES=service.name=ads_server,env=dev

export LD_LIBRARY_PATH=$HOME/otel-cpp/install/lib:$LD_LIBRARY_PATH
LD_PRELOAD=$HOME/otel-cpp-apm-demo/libotel_preload.so ./ads_server
